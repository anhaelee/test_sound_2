<!DOCTYPE html>
<html lang="en">
  <head>
    <title>three.js webgl - geometry - vertex colors</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    
    <style>
      body {color: #808080;
            font-family:Monospace;
            font-size:13px;
            text-align:center;
            background-color: #fff;
            margin: 0px;
            overflow: hidden;}
      a {color: #0080ff;}
    </style>


</head>


<body>

    <div id="container"></div>


    <script src="js/three.js"></script>
    <script src="js/Detector.js"></script>
    <script src="js/stats.min.js"></script>
    <script src="js/DragControls.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="js/soundV.js"></script>


<script>
  jQuery(document).ready(function($) {
     var container, stats;
      var camera, scene, renderer;
      var mesh, group1, group2, group3, light;
      var mouseX = 0, mouseY = 0;
  var delta = 0, dist;
  var windowHalfX = window.innerWidth / 2;
  var windowHalfY = window.innerHeight / 2;
  var toDrag = [];



/* Try instantiating a new AudioContext, throw an error if it fails. */
try {
  /* Setup an AudioContext. */
  context = new AudioContext();

  /* Create a script processor node with a `bufferSize` of 1024. */
  processor = context.createScriptProcessor(1024);

  /* Create an analyser node */
  analyser = context.createAnalyser();

  /* Wire the processor into our audio context. */
  processor.connect(context.destination);

  /* Wire the analyser into the processor */
  analyser.connect(processor);

  /* Define a Uint8Array to receive the analysers data. */
  data = new Uint8Array(analyser.frequencyBinCount);
} catch(e) {
  throw new Error('The Web Audio API is unavailable');
}

var Sound = {
  element: undefined,
  init: false,

  play: function() {
    if (this.init === false) {
      var sound = context.createMediaElementSource(this.element);

      this.element.onended = function() {
        sound.disconnect();
        sound = null;

        /* Noop the audioprocess handler when the file finishes. */
        processor.onaudioprocess = function() {};
      }

      /* Add the following line to wire into the analyser. */
      sound.connect(analyser);
      sound.connect(context.destination);

      processor.onaudioprocess = function() {
        /* Populate the data array with the frequency data. */
        analyser.getByteTimeDomainData(data);
      };

      this.init = true;
    }

    this.element.play();
  },

  pause: function() {
    this.element.pause();
  },

  paused: function() {
    return this.element.paused;
  }
};

function loadAudioElement(url) {
  return new Promise(function(resolve, reject) {
    var audio = new Audio(); // audio DOM element, same as createElement('audio')

    audio.src = url;
    audio.crossOrigin = "anonymous";

    audio.addEventListener('canplaythrough', function() {
        resolve(audio);
    });

    audio.addEventListener('error', reject);
    audio.load();
  });
}

// ----------------------------------
// visualization code
// ----------------------------------

const CUBES_NUM = 70
    , STEP = Math.floor(data.length / CUBES_NUM)
    , NO_SIGNAL = 160;


var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(20,
      window.innerWidth / window.innerHeight, 1, 10000);
camera.position.z = 1800;

var ambientLight = new THREE.AmbientLight(0xcccccc);
    scene.add(ambientLight);


 var directionalLight = new THREE.DirectionalLight(0xffffff);
    directionalLight.position.set(2, 2, 0.5).normalize();
    directionalLight.intensity = 0.75;
    scene.add(directionalLight);



var renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);
document.addEventListener( 'mousemove', onDocumentMouseMove, false );



    geometry = new THREE.TorusKnotGeometry(0.2, 0.2, 800, 30);

  

    material = new THREE.MeshNormalMaterial(  );
    
    mesh1 = new THREE.Mesh(geometry, material);
    mesh1.position.x = -1;
    mesh1.rotation.x = 0;
    scene.add(mesh1);
    toDrag.push(mesh1);

    mesh2 = new THREE.Mesh(geometry, material);
    mesh2.position.x = 0;
    mesh2.rotation.x = 0;
    scene.add(mesh2);
    toDrag.push(mesh2);


    mesh3 = new THREE.Mesh(geometry, material);
    mesh3.position.x = 1;
    mesh3.rotation.x = 0;
    scene.add(mesh3);
    toDrag.push(mesh3);
    
  



  //drag
  var dragControls = new THREE.DragControls( toDrag, camera, renderer.domElement );
  dragControls.addEventListener( 'dragstart', function ( e ) {
   // e.preventDefault()
  });
  dragControls.addEventListener( 'dragend', function ( e ) {
   // e.preventDefault()
  });
  




//mousemove
      function onDocumentMouseMove( event ) {
        mouseX = ( event.clientX - windowHalfX );
        mouseY = ( event.clientY - windowHalfY );
      }



function render() {
  requestAnimationFrame(render);


  for (let i = 0, n = 0; i < toDrag.length; i++, n+=STEP) {
    let val = Math.abs(data[n]) / NO_SIGNAL;

    toDrag[i].scale.y -= 0.85;
    toDrag[i].scale.y += Math.abs(data[n]) / NO_SIGNAL;

    if (toDrag[i].scale.y <= 1) {
      toDrag[i].scale.y = 1;
    }

    toDrag[i].position.y = (toDrag[i].scale.y / 2) - 0.5;
  }


  delta += 0.006;
  dist = 8;


  camera.lookAt(scene.position);
  camera.position.x = Math.sin(delta) * dist;
  camera.position.y = Math.cos(62) * dist;
  camera.position.z = Math.cos(delta) * dist;

  renderer.render(scene, camera);
}

render();




// Pause / play audio on page click
document.body.addEventListener('click', function(ev) {
  if (audio) {
    if (audio.paused()) {
      audio.play();
    } else {
      audio.pause();
    }
  }
});



loadAudioElement('https://s3.eu-west-2.amazonaws.com/nelsoncodepen/Cutside_-_08_-_Amaterasu.mp3').then(function(elem) {
  audio = Object.create(Sound);
  audio.element = elem;
  // audio.play();
}, function(elem) {
  throw 'Audio Failed to load';
});



  var windowHalfX = window.innerWidth / 2;
  var windowHalfY = window.innerHeight / 2;
  function onWindowResize() {
    windowHalfX = window.innerWidth / 2;
    windowHalfY = window.innerHeight / 2;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
  window.addEventListener("resize", onWindowResize, false);
});


</script>


<style>

body {
  margin: 0;
  background: #303030;
}

</style>
